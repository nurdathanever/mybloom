{% extends "base.html" %}
{% load static %}

{% block content %}
    <div class="container my-5 bg-transparent text-light p-4 rounded shadow">
        <ul class="nav nav-pills nav-fill mb-4" id="wishTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="flowers-tab" data-bs-toggle="tab" data-bs-target="#flowers"
                        type="button" role="tab">Flowers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="accessories-tab" data-bs-toggle="tab" data-bs-target="#accessories"
                        type="button" role="tab">Accessories
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="postcard-tab" data-bs-toggle="tab" data-bs-target="#postcard" type="button"
                        role="tab">Postcard
                </button>
            </li>
        </ul>

        <div class="tab-content" id="wishTabsContent">
            <div class="tab-pane fade show active" id="flowers" role="tabpanel">
                <form id="flowerForm" method="post">
                    {% csrf_token %}
                    <div class="row">
                        {% for flower in flowers %}
                            <div class="col-md-2 mb-4">
                                <div class="card h-100 text-center shadow-sm border-0 flower-card"
                                     style="transition: all 0.3s ease;">
                                    <img src="{{ flower.image.url }}" class="card-img-top img-fluid"
                                         style="object-fit: cover; border-radius: 10px;" alt="{{ flower.name }}">
                                    <div class="card-body p-2">
                                        <h6 class="card-title">{{ flower.name }}</h6>
                                        <div class="quantity-controls d-flex justify-content-center align-items-center mb-2">
                                            <button type="button" class="minus-btn"
                                                    data-id="{{ flower.id }}">-
                                            </button>
                                            <span class="mx-2" id="qty-{{ flower.id }}">0</span>
                                            <button type="button" class="plus-btn"
                                                    data-id="{{ flower.id }}">+
                                            </button>
                                        </div>
                                        <input type="hidden" name="flowers" value="{{ flower.id }}"
                                               id="input-{{ flower.id }}" disabled>
                                        <p class="flower-price text-secondary" id="price-{{ flower.id }}" data-price="{{ flower.price|floatformat }}">{{ flower.price|floatformat }} ₸</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-primary mt-3" onclick="nextTab('accessories-tab')">Next</button>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="accessories" role="tabpanel">
                <form id="accessoryForm" method="post">
                    {% csrf_token %}
                    <h4 class="text-white">Wrapping Papers</h4>
                    <div class="row mb-4">
                        {% for paper in papers %}
                            <div class="col-md-3">
                                <label class="card h-100 text-center shadow-sm border-0 accessory-card" style="transition: all 0.3s ease; cursor: pointer;">
                                    <input type="radio" name="wrapping_paper" value="{{ paper.id }}" class="d-none" autocomplete="off">
                                    <img src="{{ paper.image.url }}" class="card-img-top img-fluid"
                                         style="object-fit: cover; border-radius: 10px" alt="{{ paper.name }}">
                                    <div class="card-body p-2">
                                        <h6 class="card-title">{{ paper.name }}</h6>
                                        <p class="mb-0"><strong>{{ paper.price|floatformat }} ₸</strong></p>
                                    </div>
                                </label>
                            </div>
                        {% endfor %}
                    </div>

                    <h4 class="text-white">Ribbons</h4>
                    <div class="row mb-4">
                        {% for ribbon in ribbons %}
                            <div class="col-md-3">
                                <label class="card h-100 text-center shadow-sm border-0 accessory-card" style="transition: all 0.3s ease; cursor: pointer;">
                                    <input type="radio" name="ribbon" value="{{ ribbon.id }}" class="d-none" autocomplete="off">
                                    <img src="{{ ribbon.image.url }}" class="card-img-top img-fluid"
                                         style="object-fit: cover; border-radius: 10px" alt="{{ ribbon.name }}">
                                    <div class="card-body p-2">
                                        <h6 class="card-title">{{ ribbon.name }}</h6>
                                        <p class="mb-0"><strong>{{ ribbon.price|floatformat }} ₸</strong></p>
                                    </div>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-primary mt-3" onclick="nextTab('postcard-tab')">Next</button>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="postcard" role="tabpanel">
                <form id="postcardForm" method="post" action="{% url 'yourwish_bloomit' %}">
                    {% csrf_token %}
                    <div class="card-options row">
                        <div class="col-md-2">
                            <label class="card h-100 text-center shadow-sm border-0" style="transition: all 0.3s ease; cursor: pointer;">
                                <input type="radio" name="postcard_id" value="" class="d-none" autocomplete="off">
                                <div class="card-body p-4 d-flex align-items-center justify-content-center"
                                     style="height: 180px;">
                                    <h6 class="card-title">No Postcard</h6>
                                </div>
                            </label>
                        </div>
                        {% for card in cards %}
                            <div class="col-md-2">
                                <label class="card h-100 text-center shadow-sm border-0" style="transition: all 0.3s ease; cursor: pointer;">
                                    <input type="radio" name="postcard_id" value="{{ card.id }}" class="d-none" autocomplete="off">
                                    <img src="{{ card.image.url }}" alt="Postcard {{ card.id }}"
                                         class="card-img-top img-fluid"
                                         style="object-fit: cover; border-radius: 10px" alt="{{ card.name }}">
                                    <div class="card-body p-2">
                                        <h6 class="card-title">{{ card.name }}</h6>
                                    </div>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <label class="form-label text-light">Write your message</label>
                        <textarea name="message" class="form-control" rows="3" placeholder="Write here..."></textarea>
                    </div>
                    <div class="text-end mt-4">
                        <input type="hidden" name="step" value="postcard">
                        <input type="hidden" name="flowers_data" id="flowers_data_input">
                        <button type="submit" class="btn btn-primary">Bloom it!</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="mt-5 text-end text-white">
            <h4>Estimated Price: <span id="estimated-price">0</span> ₸</h4>
        </div>
    </div>

    <script>
        function nextTab(tabId) {
            const trigger = document.getElementById(tabId);
            if (trigger) {
                bootstrap.Tab.getOrCreateInstance(trigger).show();
                sessionStorage.setItem("activeTab", tabId);
            }
        }
        // Track active tab from backend via sessionStorage
        const selectedFlowers = {};
        let currentTab = sessionStorage.getItem("activeTab") || "flowers-tab";

        document.addEventListener("DOMContentLoaded", function () {
            const tabTrigger = new bootstrap.Tab(document.getElementById(currentTab));
            if (tabTrigger) tabTrigger.show();

            preloadQuantities();
            // Explicitly set each flower price based on dataset and selection
            document.querySelectorAll(".flower-price").forEach(el => {
                const id = el.id.replace("price-", "");
                const price = parseFloat(el.dataset.price);
                const qty = selectedFlowers[id] || 0;
                const cardTotal = qty * price;
                el.innerText = (qty > 0 ? cardTotal.toFixed(0) : price.toFixed(0)) + " ₸";
                if (qty > 0) {
                    el.classList.remove("text-secondary");
                    el.classList.add("text-white");
                } else {
                    el.classList.remove("text-white");
                    el.classList.add("text-secondary");
                }
            });
            setupQuantityButtons();
            updateEstimatedPrice();

            document.querySelectorAll('#wishTabs button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function () {
                    setupQuantityButtons();
                });
            });
        });

        function preloadQuantities() {
            document.querySelectorAll(".quantity-controls span[id^='qty-']").forEach(span => {
                const id = span.id.replace('qty-', '');
                const qty = parseInt(span.textContent) || 0;
                selectedFlowers[id] = qty;
            });
        }

        function setupQuantityButtons() {
            document.querySelectorAll(".plus-btn").forEach(btn => {
                btn.removeEventListener("click", plusClickHandler);
                btn.addEventListener("click", plusClickHandler);
            });
            document.querySelectorAll(".minus-btn").forEach(btn => {
                btn.removeEventListener("click", minusClickHandler);
                btn.addEventListener("click", minusClickHandler);
            });
        }

        function plusClickHandler(e) {
            const id = e.target.dataset.id;
            selectedFlowers[id] = (selectedFlowers[id] || 0) + 1;
            document.getElementById("qty-" + id).textContent = selectedFlowers[id];
            console.log(`Plus clicked: ID=${id}, Quantity=${selectedFlowers[id]}`);
            updateEstimatedPrice();
        }

        function minusClickHandler(e) {
            const id = e.target.dataset.id;
            selectedFlowers[id] = Math.max((selectedFlowers[id] || 0) - 1, 0);
            document.getElementById("qty-" + id).textContent = selectedFlowers[id];
            console.log(`Minus clicked: ID=${id}, Quantity=${selectedFlowers[id]}`);
            updateEstimatedPrice();
        }

        document.querySelectorAll("input[name='wrapping_paper'], input[name='ribbon'], input[name='postcard_id'], textarea[name='message']").forEach(input => {
            input.addEventListener("change", saveToSession);
            input.addEventListener("input", saveToSession);
        });

        document.querySelectorAll("input[name='wrapping_paper'], input[name='ribbon']").forEach(input => {
            input.addEventListener("change", updateEstimatedPrice);
        });

        function updateEstimatedPrice() {
            console.log("Updating estimated price with selectedFlowers:", selectedFlowers);
            let total = 0;
            // Set prices and classes for all flower cards, regardless of selection
            document.querySelectorAll(".flower-price").forEach(el => {
                const id = el.id.replace("price-", "");
                const price = parseFloat(el.dataset.price);
                const qty = selectedFlowers[id] || 0;
                const cardTotal = qty * price;
                el.innerText = (qty > 0 ? cardTotal.toFixed(0) : price.toFixed(0)) + " ₸";
                if (qty > 0) {
                    el.classList.remove("text-secondary");
                    el.classList.add("text-white");
                } else {
                    el.classList.remove("text-white");
                    el.classList.add("text-secondary");
                }
            });
            Object.entries(selectedFlowers).forEach(([id, qty]) => {
                const priceEl = document.querySelector(`#price-${id}`);
                const pricePerItem = parseFloat(priceEl.dataset.price);
                const cardTotal = qty * pricePerItem;
                total += cardTotal;
            });

            const wrappingPrice = parseFloat(document.querySelector("input[name='wrapping_paper']:checked")?.closest('.card').querySelector('strong')?.innerText || 0);
            const ribbonPrice = parseFloat(document.querySelector("input[name='ribbon']:checked")?.closest('.card').querySelector('strong')?.innerText || 0);

            total += isNaN(wrappingPrice) ? 0 : wrappingPrice;
            total += isNaN(ribbonPrice) ? 0 : ribbonPrice;

            document.getElementById("estimated-price").innerText = total.toFixed(0);
        }

        function saveToSession() {
            const data = {
                flowers: selectedFlowers,
                wrapping_paper: document.querySelector("input[name='wrapping_paper']:checked")?.value,
                ribbon: document.querySelector("input[name='ribbon']:checked")?.value,
                postcard_id: document.querySelector("input[name='postcard_id']:checked")?.value,
                message: document.querySelector("textarea[name='message']")?.value,
            };
            sessionStorage.setItem("yourwishData", JSON.stringify(data));
        }

        // Inject data into final form
        document.getElementById("postcardForm").addEventListener("submit", function (e) {
            const data = sessionStorage.getItem("yourwishData");
            if (data) {
                document.getElementById("flowers_data_input").value = data;
            }
            Object.entries(selectedFlowers).forEach(([id, qty]) => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = `flowers_${id}`;
                input.value = qty;
                this.appendChild(input);
            });

            const wrapping = document.querySelector("input[name='wrapping_paper']:checked")?.value;
            if (wrapping) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "wrapping_paper";
                input.value = wrapping;
                this.appendChild(input);
            }

            const ribbon = document.querySelector("input[name='ribbon']:checked")?.value;
            if (ribbon) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "ribbon";
                input.value = ribbon;
                this.appendChild(input);
            }
        });
    </script>
    <style>
        .card {
            color: white;
        }
        .flower-card:hover {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
            transform: scale(1.02);
        }

        .accessory-card:hover,
        .card-options .card:hover {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
            transform: scale(1.02);
        }
        .flower-card, .accessory-card, .card-options .card {
            background: none !important;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-family: 'Cormorant Unicase', serif;
        }
        .flower-card .card-title, .accessory-card .card-title, .card-options .card-title {
            font-family: 'Cormorant Unicase', serif;
        }
        .quantity-controls button {
            background: none;
            border: none;
            color: #fff;
            font-family: 'Cormorant Unicase', serif;
            padding: 2px 10px;
        }
        .quantity-controls button:hover {
            background: #EB889E;
            border-color: #EB889E;
            color: #fff;
        }
        #wishTabs {
            position: sticky;
            top: 80px;
            z-index: 10;
            background: rgba(67, 67, 67, 0.4);
            backdrop-filter: blur(8px);
        }
        .nav-link {
            color: #fff;
        }
        /* Highlight selected accessory or postcard */
        input[type="radio"]:checked + img,
        input[type="radio"]:checked + .card-body {
            border: 2px solid #EB889E;
            box-shadow: 0 0 10px #EB889E;
        }
        label.card input[type="radio"]:checked ~ img,
        label.card input[type="radio"]:checked ~ .card-body {
            border: 2px solid #EB889E;
            box-shadow: 0 0 10px #EB889E;
        }
    </style>
{% endblock %}
